// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now()) @map("created_at")

  // Subscription
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  subscriptionStatus     String?   @default("free") @map("subscription_status") // free, active, canceled, past_due
  subscriptionTier       String?   @default("free") @map("subscription_tier") // free, basic, pro, premium
  currentPeriodEnd       DateTime? @map("current_period_end")

  clothingItems     ClothingItem[]
  outfitRecs        OutfitRecommendation[]
  savedOutfits      SavedOutfit[]
  wearEvents        WearEvent[]
  uploads           Upload[]
  styleProfile      StyleProfile?
  capsuleWardrobes  CapsuleWardrobe[]
  purchaseHistory   PurchaseHistory[]
  emailConnection   EmailConnection?

  @@map("users")
}

model ClothingItem {
  id        Int      @id @default(autoincrement())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?  @map("user_id")

  imageUrl  String   @map("image_url")
  blobPath  String?  @map("blob_path")
  embedding Float[] @map("embedding") @db.DoublePrecision @default([])

  // AI metadata
  type          String?
  primaryColor  String?  @map("primary_color")
  secondaryColor String? @map("secondary_color")
  pattern       String?
  fit           String?
  vibe          String?
  notes         String?
  layeringCategory String? @map("layering_category")

  tags          String[]

  wearEvents    WearEvent[]

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId], name: "clothing_items_user_idx")
  @@index([type], name: "idx_clothing_type")
  @@index([primaryColor], name: "idx_clothing_color")
  @@index([tags], type: Gin, name: "idx_tags_gin")
  @@map("clothing_items")
}

model StyleRule {
  id          Int      @id @default(autoincrement())
  source      String
  title       String?
  description String?
  rule        Json
  season      String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("style_rules")
}

model OutfitRecommendation {
  id          Int        @id @default(autoincrement())
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String?    @map("user_id")

  items             Int[]
  occasion          String?
  generatedBy       String?  @map("generated_by")
  confidenceScore   Float?   @map("confidence_score")
  aiExplanation     String?  @map("ai_explanation")
  embedding         Float[] @map("embedding") @db.DoublePrecision @default([])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId], name: "outfit_recommendations_user_idx")
  @@index([items], type: Gin, name: "idx_outfits_items")
  @@map("outfit_recommendations")
}

model SavedOutfit {
  id        Int      @id @default(autoincrement())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?  @map("user_id")

  items     Int[]
  name      String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("saved_outfits")
}

model WearEvent {
  id            Int      @id @default(autoincrement())
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String?  @map("user_id")
  clothingItem  ClothingItem @relation(fields: [clothingItemId], references: [id], onDelete: Cascade)
  clothingItemId Int     @map("clothing_item_id")

  wornOn    DateTime  @map("worn_on")
  context   String?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId], name: "wear_events_user_idx")
  @@map("wear_events")
}

model Upload {
  id            Int      @id @default(autoincrement())
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String?  @map("user_id")

  imageUrl      String   @map("image_url")
  status        String?
  errorMessage  String?  @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("uploads")
}

model StyleProfile {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique @map("user_id")

  preferredStyles   String[] @map("preferred_styles")
  occasionFrequency Json     @map("occasion_frequency")
  favoriteColors    String[] @map("favorite_colors")
  bodyType          String?  @map("body_type")
  climate           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("style_profiles")
}

model CapsuleWardrobe {
  id        Int      @id @default(autoincrement())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?  @map("user_id")

  name              String
  period            String   // "weekly" or "monthly"
  itemIds           Int[]    @map("item_ids")
  outfitPlan        Json     @map("outfit_plan") // Daily outfit schedule
  versatilityScore  Int      @map("versatility_score")

  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId], name: "capsule_wardrobes_user_idx")
  @@index([period], name: "idx_capsule_period")
  @@map("capsule_wardrobes")
}

model PurchaseHistory {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String   @map("user_id")

  // Purchase details
  itemName        String   @map("item_name")
  brand           String?
  store           String
  purchaseDate    DateTime @map("purchase_date")
  price           Float?
  orderNumber     String?  @unique @map("order_number")

  // Extracted metadata (from AI)
  itemType        String?  @map("item_type")
  color           String?
  pattern         String?
  estimatedVibe   String?  @map("estimated_vibe")

  // Email reference
  emailId         String?  @map("email_id")
  emailSubject    String?  @map("email_subject")

  // Status
  addedToWardrobe Boolean  @default(false) @map("added_to_wardrobe")
  clothingItemId  Int?     @map("clothing_item_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId], name: "purchase_history_user_idx")
  @@index([purchaseDate], name: "idx_purchase_date")
  @@index([store], name: "idx_store")
  @@map("purchase_history")
}

model EmailConnection {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String   @unique @map("user_id")

  provider    String   // "gmail"
  accessToken String   @map("access_token")
  refreshToken String? @map("refresh_token")
  expiresAt   DateTime? @map("expires_at")

  lastSyncedAt DateTime? @map("last_synced_at")
  isActive     Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("email_connections")
}
